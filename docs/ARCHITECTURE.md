# 架构设计文档

本文档介绍 MP Preview 插件的整体架构和核心设计决策。

## 目录
1. [整体架构](#整体架构)
2. [核心模块](#核心模块)
3. [数据流](#数据流)
4. [设计决策](#设计决策)

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        Obsidian                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    MPPlugin                            │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌────────────────┐ │ │
│  │  │   MPView    │  │  Settings   │  │   Commands     │ │ │
│  │  │  (预览视图)  │  │  (设置管理)  │  │   (命令注册)    │ │ │
│  │  └──────┬──────┘  └─────────────┘  └────────────────┘ │ │
│  └─────────┼──────────────────────────────────────────────┘ │
└────────────┼────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────┐
│                      核心功能层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │ TemplateManager│  │  MPConverter │  │  CopyManager     │  │
│  │  (模板管理)    │  │  (内容转换)   │  │  (复制功能)       │  │
│  └──────────────┘  └──────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────┘
             │
             ▼
┌─────────────────────────────────────────────────────────────┐
│                        输出层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │   预览渲染    │  │  剪贴板操作   │  │   文件系统        │  │
│  └──────────────┘  └──────────────┘  └──────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. MPPlugin - 插件入口

**职责**：
- 插件生命周期管理
- 模块初始化
- 注册视图、命令、设置

**设计要点**：
```typescript
export default class MPPlugin extends Plugin {
    // 延迟初始化，避免启动时加载
    private view: MPView;
    
    async onload() {
        // 1. 加载设置
        // 2. 注册视图
        // 3. 注册命令
        // 4. 注册设置面板
    }
}
```

**关键决策**：
- 使用 Obsidian 的插件 API 进行生命周期管理
- 采用延迟加载策略，避免影响 Obsidian 启动速度

---

### 2. MPView - 预览视图

**职责**：
- 渲染预览面板 UI
- 管理预览内容更新
- 协调各功能模块

**架构设计**：
```
MPView
├── Toolbar (工具栏)
│   ├── 复制按钮
│   ├── 锁定按钮
│   └── 设置控件
├── PreviewArea (预览区域)
│   └── ContentSection (内容容器)
└── EventHandlers (事件处理)
    ├── 文件变化监听
    └── 滚动同步
```

**状态管理**：
```typescript
class MPView extends ItemView {
    private currentFile: TFile | null;  // 当前文件
    private isLocked: boolean;           // 锁定状态
    private updateTimer: NodeJS.Timeout; // 防抖定时器
}
```

**关键决策**：
- 使用防抖机制避免大文件频繁刷新
- 提供锁定功能让用户控制刷新时机
- 基于事件驱动，监听文件变化自动更新

---

### 3. TemplateManager - 模板系统

**职责**：
- 管理预设模板
- 应用样式到 DOM 元素
- 处理字体、字号设置

**模板结构**：
```typescript
interface Template {
    id: string;
    name: string;
    styles: {
        container: string;     // 容器样式
        title: { ... };        // 标题样式
        paragraph: string;     // 段落样式
        list: { ... };         // 列表样式
        code: { ... };         // 代码块样式
        emphasis: {            // 强调样式
            strong: string;    // 加粗
            em: string;        // 斜体
            del: string;       // 删除线
        };
        // ... 其他样式
    };
}
```

**样式应用策略**：
1. **内联样式优先**：使用 `setAttribute('style', ...)` 直接设置
2. **强制覆盖**：使用 `!important` 确保样式优先级
3. **动态计算**：根据当前字体、字号动态生成样式

**关键决策**：
- 样式以内联方式应用，确保复制到公众号后样式不丢失
- 使用 `!important` 覆盖 Obsidian 默认样式
- 支持运行时切换模板和字体

---

### 4. MPConverter - 内容转换器

**职责**：
- 转换 Obsidian 特有元素
- 处理内部链接和图片
- 优化代码块显示

**转换流程**：
```
原始 Markdown
    ↓
Obsidian MarkdownRenderer
    ↓
MPConverter.formatContent()
├── 创建 section 容器
├── 处理列表项（用 section 包裹）
├── 处理代码块（添加 macOS 风格头部）
├── 处理内部图片链接
└── 处理 MathJax 公式（可选）
    ↓
TemplateManager.applyTemplate()
    ↓
最终 HTML
```

**关键决策**：
- 在 Obsidian 渲染后处理，而不是直接操作 Markdown
- 使用 DOM 操作而非字符串替换，更可靠
- 异步处理图片，转换为 base64 以便复制

---

### 5. CopyManager - 复制功能

**职责**：
- 将预览内容转换为可复制格式
- 处理图片 base64 编码
- 清理不必要的属性和样式

**复制流程**：
```
用户点击复制
    ↓
克隆预览元素
    ↓
processImages()
├── 遍历所有 img 标签
├── fetch 图片资源
└── 转换为 base64 DataURL
    ↓
cleanupHtml()
├── 移除 data-* 属性
├── 移除 class 属性
├── 移除 id 属性
└── 序列化为 HTML 字符串
    ↓
写入剪贴板
├── text/html 格式
└── text/plain 格式
```

**关键决策**：
- 克隆元素而非直接操作，避免影响预览
- 将图片转为 base64，确保粘贴后图片可用
- 清理 class 和 id 避免与公众号样式冲突
- 同时提供 HTML 和纯文本格式

---

### 6. SettingsManager - 设置管理

**职责**：
- 持久化用户设置
- 提供默认配置
- 管理模板数据

**设置结构**：
```typescript
interface MPSettings {
    // 当前选中的模板
    currentTemplate: string;
    // 字体设置
    fontFamily: string;
    fontSize: number;
    // 背景设置
    background: string;
    // 自定义模板（用户创建）
    customTemplates: Template[];
}
```

**存储策略**：
- 使用 Obsidian `Plugin.saveData()` / `loadData()` API
- 设置存储在 `.obsidian/plugins/mp-preview/data.json`

---

## 数据流

### 预览更新流程

```
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐
│  文件修改    │────▶│  Workspace   │────▶│   onFileModify  │
│  (用户编辑)  │     │   事件系统    │     │    (防抖处理)    │
└─────────────┘     └──────────────┘     └────────┬────────┘
                                                   │
                                                   ▼
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐
│  应用样式   │◀────│ updatePreview │◀────│   cachedRead    │
│ (Template)  │     │   (渲染流程)   │     │  (读取文件内容)  │
└──────┬──────┘     └──────────────┘     └─────────────────┘
       │
       ▼
┌─────────────┐
│   预览显示   │
└─────────────┘
```

### 复制流程

```
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐
│  点击复制    │────▶│   克隆元素    │────▶│  processImages  │
│   按钮      │     │  (cloneNode)  │     │  (base64转换)   │
└─────────────┘     └──────────────┘     └────────┬────────┘
                                                   │
                                                   ▼
┌─────────────┐     ┌──────────────┐     ┌─────────────────┐
│  写入剪贴板  │◀────│  cleanupHtml │◀────│   序列化HTML    │
│ (clipboard) │     │  (清理属性)   │     │  (XMLSerializer) │
└─────────────┘     └──────────────┘     └─────────────────┘
```

---

## 设计决策

### 1. 为什么选择内联样式？

**问题**：为什么不用 CSS 类，而是直接设置 style 属性？

**决策**：
- ✅ 复制到公众号后，外部 CSS 会丢失
- ✅ 内联样式可以确保格式一致
- ❌ 增加了 HTML 体积
- ❌ 难以在浏览器中调试样式

### 2. 为什么使用防抖？

**问题**：实时预览为什么不立即更新？

**决策**：
- ✅ 大文件频繁更新会导致卡顿
- ✅ 用户可能正在连续输入
- ✅ 500ms 延迟在可接受范围内
- ❌ 用户需要等待才能看到更新

### 3. 为什么图片要转 base64？

**问题**：为什么不能保留原链接？

**决策**：
- ✅ 本地图片链接在公众号中无法访问
- ✅ base64 图片可以完整复制
- ❌ 增加了剪贴板数据大小
- ❌ 处理时间增加

### 4. 模板系统的设计

**问题**：为什么不使用纯 CSS 文件？

**决策**：
- ✅ TypeScript 对象便于运行时操作
- ✅ 可以动态组合样式
- ✅ 支持用户自定义模板
- ❌ 不如 CSS 灵活
- ❌ 学习成本较高

---

## 扩展点

### 如何添加新模板？

1. 在 `src/settings/settings.ts` 定义模板配置
2. 在 `TemplateManager` 中添加模板切换逻辑
3. 在设置面板中添加 UI 选项

### 如何支持新的 Markdown 元素？

1. 在 `MPConverter` 中添加转换逻辑
2. 在模板中定义对应样式
3. 在 `TemplateManager.applyTemplate()` 中应用样式

### 如何添加新的复制格式？

1. 在 `CopyManager` 中添加处理方法
2. 修改 `copyToClipboard()` 支持多格式
3. 在 UI 中添加格式选择器

---

## 性能考虑

### 大文件优化

- 使用防抖避免频繁刷新
- 提供锁定功能暂停实时预览
- 图片懒加载（可选）

### 内存管理

- 及时清理定时器
- 避免重复注册事件
- 使用 `weakref` 引用 DOM 元素（可选）

---

## 安全考虑

1. **XSS 防护**：所有 HTML 内容都经过 Obsidian 的 MarkdownRenderer 处理
2. **CSP**：不加载外部脚本
3. **文件访问**：只读取 vault 内的文件
